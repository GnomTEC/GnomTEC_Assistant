-- **********************************************************************
-- GnomTECLayoutVertical
-- Version: 5.4.7.1
-- Author: GnomTEC
-- Copyright 2014 by GnomTEC
-- http://www.gnomtec.de/
-- **********************************************************************
-- load localization first.
local L = LibStub("AceLocale-3.0"):GetLocale("GnomTEC")


-- ----------------------------------------------------------------------
-- Layout Global Constants (local)
-- ----------------------------------------------------------------------
-- Log levels
local LOG_FATAL 	= 0
local LOG_ERROR	= 1
local LOG_WARN		= 2
local LOG_INFO 	= 3
local LOG_DEBUG 	= 4

-- ----------------------------------------------------------------------
-- Layout Static Variables (local)
-- ----------------------------------------------------------------------


-- ----------------------------------------------------------------------
-- Layout Startup Initialization
-- ----------------------------------------------------------------------


-- ----------------------------------------------------------------------
-- Layout Functions (local)
-- ----------------------------------------------------------------------


-- ----------------------------------------------------------------------
-- Layout Class
-- ----------------------------------------------------------------------

function GnomTECLayoutVertical()
	-- call base class
	local self, protected = GnomTECLayout()	

	-- public fields go in the instance table
	-- self.field = value

	-- protected fields go in the protected table
	-- protected.field = value

	-- private fields are implemented using locals
	-- they are faster than table access, and are truly private, so the code that uses your class can't get them
	-- local field
		
	-- private methods
	-- local function f()

	-- protected methods
	-- function protected.f()
	
	-- public methods
	-- function self.f()
	function self.LogMessage(level, message, ...)
		protected.LogMessage("<Layout> GnomTECLayoutVertical", level, message, ...)
	end

	local base_Init = self.Init
	function self.Init(containerWidget, containerProtected)
		base_Init(containerWidget, containerProtected)
	end
	
	function self.GetMinReseize()
		-- should be calculated according childs and layouter
		local minWidth = 0
		local minHeight = 0

		for idx, value in ipairs(protected.containerProtected.childs) do
			if (value.widget.IsShown()) then				
				local widgetMinWidth, widgetMinHeight = value.widget.GetMinReseize()
				if (widgetMinWidth > minWidth) then
					minWidth = widgetMinWidth
				end
				minHeight = minHeight + widgetMinHeight
			end
		end

		if (minWidth > UIParent:GetWidth()) then
			minWidth = UIParent:GetWidth()
		end
		if (minHeight > UIParent:GetHeight()) then
			minHeight = UIParent:GetHeight()
		end

		return minWidth, minHeight
	end

	function self.GetMaxReseize()
		-- should be calculated according childs and layouter
		local maxWidth = 0
		local maxHeight = 0

		for idx, value in ipairs(protected.containerProtected.childs) do
			if (value.widget.IsShown()) then
				local widgetMaxWidth, widgetMaxHeight = value.widget.GetMaxReseize()
				if (0 == maxWidth) or (widgetMaxWidth < maxWidth) then
					maxWidth = widgetMaxWidth
				end
				maxHeight = maxHeight + widgetMaxHeight
			end
		end

		if (maxWidth > UIParent:GetWidth()) then
			maxWidth = UIParent:GetWidth()
		end
		if (maxHeight > UIParent:GetHeight()) then
			maxHeight = UIParent:GetHeight()
		end
		
		return maxWidth, maxHeight
	end

	function self.IsProportionalReseize()
		-- should be calculated according childs and layouter
		local isProp = true
		
		for idx, value in ipairs(protected.containerProtected.childs) do
			if (value.widget.IsShown()) then
				isProp = isProp and value.widget.IsProportionalReseize()
				if (not isProp) then break end
			end
		end
		return isProp
	end
	
	function self.ResizeByWidth(pixelWidth)
		-- should be calculated according childs and layouter
		local pixelHeight = 0
		for idx, value in ipairs(protected.containerProtected.childs) do
			if (value.widget.IsShown()) then
				local widgetPixelHeight = value.widget.ResizeByWidth(pixelWidth)
				pixelHeight = pixelHeight + widgetPixelHeight
			end
		end

		-- we don't change the size in layouter as we don't know what to do
		-- but we can compute the needed size of layout and report it to the container widget
		return pixelHeight
	end

	function self.ResizeByHeight(pixelHeight)
		-- should be calculated according childs and layouter
		local pixelWidth = 0
		local widgets = {}
		local relativeHeight = 0
		
		for idx, value in ipairs(protected.containerProtected.childs) do
			if (value.widget.IsShown()) then
				local widget = {}
				widget.widget = value.widget
				widget.relativeHeight = value.widget.GetRelativeHeight()
				_, widget.minHeight = value.widget.GetMinReseize()
				_, widget.maxHeight = value.widget.GetMaxReseize()
				relativeHeight = relativeHeight + value.widget.GetRelativeHeight()
				table.insert(widgets, widget)
			end
		end
		
		while (0 ~= #widgets) do
			local restWidgets = {}
			local restPixelHeight = pixelHeight
			local restRelativeHeight = relativeHeight
			
			if (1 > relativeHeight) then
				relativeHeight = 1
			end
		
			-- check if one is too big
			local isTooBig = false
			for idx, value in ipairs(widgets) do
				local height = pixelHeight / relativeHeight * value.relativeHeight
				if (height > value.maxHeight) then
					local width = value.ResizeByHeight(value.maxHeight)
					if (width > pixelWidth) then
						pixelWidth = width
					end
					restPixelHeight = restPixelHeight - value.maxHeight
					restRelativeHeight = restRelativeHeight - value.relativeHeight
					isToBig = true
				else
					table.insert(restWidgets, value)
				end			
			end
			widgets = restWidgets
			
			if (not isTooBig) and (0 ~= #widgets) then
			-- check if one is too small
				local isTooSmall = false
				for idx, value in ipairs(widgets) do
					local height = pixelHeight / relativeHeight * value.relativeHeight
					if (height < value.mineight) then
						local width = value.ResizeByHeight(value.minHeight)
						if (width > pixelWidth) then
							pixelWidth = width
						end
						restPixelHeight = restPixelHeight - value.minHeight
						restRelativeHeight = restRelativeHeight - value.relativeHeight
						isTooSmall = true
					else
						table.insert(restWidgets, value)
					end			
				end
				widgets = restWidgets

				if (not isTooSmall) and (0 ~= #widgets) then
					for idx, value in ipairs(widgets) do
						local height = pixelHeight / relativeHeight * value.relativeHeight
						local width = value.ResizeByHeight(height)
						if (width > pixelWidth) then
							pixelWidth = width
						end
					end
					widgets = {}		
				end
			end

			pixelHeight = restPixelHeight
			relativeHeight = restRelativeHeight
		end

		-- we don't change the size in layouter as we don't know what to do
		-- but we can compute the needed size of layout and report it to the container widget
		return pixelWidth
	end

	function self.TriggerResize(child, dx, dy)
		-- a resize is triggered by some child
		-- here we can prepare for later resize
	end
	
	-- constructor
	do

		self.LogMessage(LOG_DEBUG, "New GnomTECLayoutVertical instance created (%s)", protected.layoutUID)
	end
	
	-- return the instance and protected table
	return self, protected
end
